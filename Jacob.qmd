```{r}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(stringr)
```

```{r}
# #Read in inflation data 
Inflation <- read.csv("data/historicalinflationcalculator.csv") %>%
  filter(Year != 2024) %>%
  select(-Ave) %>% 
  mutate(Feb = as.double(Feb)) %>% 
  pivot_longer(Jan:Dec, names_to = "Month", values_to = "Inflation")
```

```{r}
all_csvs<- c("data/nasdaq_prices/stocks/UPS.csv", "data/nasdaq_prices/stocks/MMM.csv", "data/nasdaq_prices/stocks/AEP.csv", "data/nasdaq_prices/stocks/UNH.csv", "data/nasdaq_prices/stocks/JPM.csv", "data/nasdaq_prices/stocks/AMZN.csv", "data/nasdaq_prices/stocks/MC.csv", "data/nasdaq_prices/stocks/KO.csv", "data/nasdaq_prices/stocks/PG.csv", "data/nasdaq_prices/stocks/AAPL.csv", "data/nasdaq_prices/stocks/MSFT.csv", "data/nasdaq_prices/stocks/GOOG.csv", "data/nasdaq_prices/stocks/AMT.csv", "data/nasdaq_prices/stocks/SPG.csv", "data/nasdaq_prices/stocks/XOM.csv", "data/nasdaq_prices/stocks/SHW.csv")

container <- vector("list", length(all_csvs))

clean_data <- function(path){
  data<-read.csv(path)
  stockName <- str_extract(path, "[^/]+(?=\\.csv$)")
  data %>%
    mutate(pRange = High - Low,
           PriceDirection = ifelse(Open < Close, "Increase", ifelse(Open > Close, "Decrease", "No Change")),
           DailyPricePercentage = ((Close - Open) / Open) * 100,
           DailyPriceChange = Open - Close,
           PriceVolatilityPercent = ((High - Low) / Open) * 100, 
           Ticker = stockName)
}

for (i in seq_along(all_csvs)){
  cleaned_data <- clean_data(all_csvs[i])
  container[[i]] <- cleaned_data
}

stock_data <- container%>%
  bind_rows()
```


```{r}
sector<-tibble(
  Ticker = c("UPS", "MMM", "AEP", "UNH", "JPM", "AMZN", "MC"," KO", "PG", "AAPL", "MSFT", "GOOG", "AMT", "SPG", "XOM", "SHW"), 
  Sector = c("Industrials", "Industrials", "Utilities", "Healthcare", "Financials", "Consumer Discretionary", "Consumer Discretionary", "Consumer Staples", "Consumer Staples", "Information Technology", "Information Technology", "Communication Services", "Real Estate", "Real Estate", "Energy", "Materials")
)

stock_data_joined<-stock_data %>% 
  mutate(Year = year(Date), Month = as.character(month(Date, label = TRUE))) %>% 
  left_join(Inflation, by = c("Year", "Month")) %>% 
  left_join(sector, by = "Ticker")
  
  
```



```{r}
ggplot(stock_data_joined, aes(x=Inflation, y=DailyPriceChange))+
  geom_point()+
  facet_wrap(~Sector)

```

```{r}
stock_data_joined %>% 
  group_by(Sector, Year) %>% 
  summarize(mean = mean(Close, na.rm = TRUE)) %>% 
  filter(!is.na(Sector)) %>% 
  ggplot(aes(x=Year, y=mean))+
  geom_point()+
  facet_wrap(~Sector)+
  theme_minimal()+
  labs(x = "Year", y = "Mean Closing Price", title = "Mean Closing Price per Sector by Year")+
  theme(panel.spacing = unit(1, "lines"))
```

```{r, fig.width=15}
stock_data_joined %>%
  group_by(Sector, Month) %>%
  summarise(mean_prange = mean(pRange, na.rm = TRUE)) %>% 
  filter(!is.na(Sector)) %>% 
  mutate(Month = fct_relevel(Month, month.abb)) %>% 
  ggplot(aes(x=Month, y=mean_prange))+
  geom_point()+
  facet_wrap(~Sector)+
  theme_minimal()+
  labs(x= "Months", y = "Mean Price Range", title = "Mean Price Range per Month by Sector")+
  theme(panel.spacing = unit(1, "lines"))
```

